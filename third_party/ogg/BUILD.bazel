load("@rules_cc//cc:defs.bzl", "cc_import", "cc_library")

# Use Zig as C compiler to build libogg
genrule(
    name = "ogg_static",
    srcs = [
        "@ogg//:ogg_srcs",
        "@ogg//:ogg_headers",
        "@ogg//:ogg_internal_headers",
    ],
    outs = ["libogg.a"],
    cmd = """
        set -e
        export HOME=/tmp
        export ZIG_LOCAL_CACHE_DIR=/tmp/zig-cache
        export ZIG_GLOBAL_CACHE_DIR=/tmp/zig-cache
        mkdir -p /tmp/zig-cache
        
        WORK=$$(mktemp -d)
        trap "rm -rf $$WORK" EXIT
        
        # Setup include directory structure
        mkdir -p $$WORK/include/ogg
        mkdir -p $$WORK/src
        mkdir -p $$WORK/obj
        
        # Copy public headers
        for hdr in $(locations @ogg//:ogg_headers); do
            cp $$hdr $$WORK/include/ogg/
        done
        
        # Copy internal headers
        for hdr in $(locations @ogg//:ogg_internal_headers); do
            cp $$hdr $$WORK/src/
        done
        
        # Copy source files
        for src in $(locations @ogg//:ogg_srcs); do
            cp $$src $$WORK/src/
        done
        
        # Compile source files
        for src in $$WORK/src/*.c; do
            base=$$(basename $$src .c)
            zig cc -c $$src -o $$WORK/obj/$$base.o \
                -I$$WORK/include \
                -I$$WORK/src \
                -fPIC \
                -O2 \
                -w
        done
        
        # Create static library
        ar rcs $@ $$WORK/obj/*.o
    """,
    visibility = ["//visibility:private"],
)

genrule(
    name = "ogg_headers_gen",
    srcs = ["@ogg//:ogg_headers"],
    outs = [
        "include/ogg/ogg.h",
        "include/ogg/os_types.h",
    ],
    cmd = """
        mkdir -p $$(dirname $(location include/ogg/ogg.h))
        for f in $(SRCS); do
            base=$$(basename $$f)
            case "$$base" in
                ogg.h) cp $$f $(location include/ogg/ogg.h) ;;
                os_types.h) cp $$f $(location include/ogg/os_types.h) ;;
            esac
        done
    """,
    visibility = ["//visibility:private"],
)

cc_import(
    name = "ogg_import",
    static_library = ":ogg_static",
    visibility = ["//visibility:private"],
)

cc_library(
    name = "ogg",
    hdrs = [":ogg_headers_gen"],
    includes = ["include"],
    visibility = ["//visibility:public"],
    deps = [":ogg_import"],
)
