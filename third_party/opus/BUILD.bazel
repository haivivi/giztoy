load("@rules_cc//cc:defs.bzl", "cc_import", "cc_library")

# Build libopus audio codec as static library
genrule(
    name = "opus_static",
    srcs = [
        "@opus//:opus_srcs",
        "@opus//:opus_public_headers",
        "@opus//:opus_internal_headers",
        "config.h",
    ],
    outs = ["libopus.a"],
    cmd = """
        set -e
        OUTDIR=$$(mktemp -d)
        CONFIG_DIR=$$(mktemp -d)
        trap "rm -rf $$OUTDIR $$CONFIG_DIR" EXIT
        cp $(location config.h) $$CONFIG_DIR/config.h
        
        for src in $(locations @opus//:opus_srcs); do
            base=$$(basename $$src .c)
            clang -c $$src -o $$OUTDIR/$$base.o \
                -I$$CONFIG_DIR \
                -Iexternal/+audio_libs+opus/include \
                -Iexternal/+audio_libs+opus/celt \
                -Iexternal/+audio_libs+opus/silk \
                -Iexternal/+audio_libs+opus/silk/float \
                -Iexternal/+audio_libs+opus \
                -DHAVE_CONFIG_H \
                -DOPUS_BUILD \
                -O2 \
                -w
        done
        
        ar rcs $@ $$OUTDIR/*.o
    """,
    visibility = ["//visibility:public"],
)

genrule(
    name = "opus_headers",
    srcs = ["@opus//:opus_public_headers"],
    outs = [
        "include/opus.h",
        "include/opus_custom.h",
        "include/opus_defines.h",
        "include/opus_multistream.h",
        "include/opus_projection.h",
        "include/opus_types.h",
    ],
    cmd = """
        mkdir -p $(@D)/include
        for f in $(SRCS); do
            cp $$f $(@D)/include/
        done
    """,
    visibility = ["//visibility:public"],
)

cc_import(
    name = "opus_import",
    static_library = ":opus_static",
    visibility = ["//visibility:private"],
)

cc_library(
    name = "opus",
    hdrs = [":opus_headers"],
    includes = ["include"],
    visibility = ["//visibility:public"],
    deps = [":opus_import"],
)
