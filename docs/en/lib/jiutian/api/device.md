# 设备接入协议

终端智能体服务管理平台设备接入协议文档

## 文档变更记录

| 日期 | 版本 | 操作内容 | 操作人 |
| --- | --- | --- | --- |
| 2025/2/28 | V1.0 | 定义AI硬件设备接入终端智能体服务管理平台的相关接口协议 | 朱才文 |
| 2025/5/9 | V1.0 | 修改心跳上报参数说明 | 朱才文 |
| 2025/5/13 | V1.0 | 蜂窝类产品必传imei，非蜂窝类产品必传cmei；增加AI设备管理接入流程；增加常见问题Q&A | 朱才文 |

## AI 设备管理接入流程

1. 在终端智能体服务管理平台创建产品和导入测试批次适配设备，得到**产品ID**和**产品秘钥**
2. 设备端使用从平台获取到的产品ID和产品秘钥调用**获取设备信息接口**，得到**设备ID**和**设备密钥**
3. 设备端使用从调用获取设备信息接口得到的设备ID、设备密钥调用**心跳接口**上报设备数据

## 环境配置

| 环境 | 地址 |
| --- | --- |
| 测试环境 | https://62b98tux.cxzfdm.com:30101 |
| 正式环境 | https://ivs.chinamobiledevice.com:11443 |

## 获取设备信息接口

接口描述：设备通过产品信息及设备号从云端获取设备信息。

> **注意**：同样的设备号每次获取的信息是不变的，如果已经获取过了设备信息，就不用再调用此接口，除非本地数据已清除或设备号有变更。前提是设备号已录入到云端平台。

### 接口信息

| 项目 | 值 |
| --- | --- |
| 接口 URL | `v2/customer/device/secret/info` |
| 请求方式 | POST |
| Content-Type | application/json |

### Header 参数

| 参数名 | 是否必须 | 说明 |
| --- | --- | --- |
| X-AI-IP | 非设备接入时必传 | 设备 IP 地址 |

### Body 参数

| 字段 | 说明 | 值类型 | 是否必填 |
| --- | --- | --- | --- |
| deviceNoType | 设备号类型（三选一）：`SN`、`IMEI`、`CMEI` | string | 是 |
| deviceNo | 设备号，产品内唯一标识设备的字串 | string | 是 |
| productId | 产品ID，平台创建产品时生成 | string | 是 |
| productKey | 产品密钥，平台创建产品时生成 | string | 是 |

### 返回值

| 字段 | 说明 | 值类型 |
| --- | --- | --- |
| code | `200`: 成功，`500`: 设备或产品不存在 | string |
| message | 响应结果，错误提示通过 msg 分析 | string |
| success | true | bool |
| data | 响应数据 | object |
| data.deviceId | 设备ID，平台上唯一设备标识 | string |
| data.deviceNo | 设备号，产品内唯一标识设备的字串 | string |
| data.productId | 产品ID，平台创建产品时生成 | string |
| data.deviceSecret | 设备密钥，平台导入设备时生成 | string |

### 返回示例

```json
{
  "code": "200",
  "message": "成功",
  "success": true,
  "data": {
    "deviceId": "xxx",
    "deviceNo": "xxx",
    "productId": "xxx",
    "deviceSecret": "xxx"
  }
}
```

## 心跳上报接口

接口描述：设备向云端上报信息，更新最后活动时间。

> **要求**：除设备无法连接网络外，24小时至少上报一次。

### 请求策略（参考）

**策略1**：设备每天首次使用时上报设备数据信息。

**策略2**：设备每隔12小时向平台上报设备数据信息。

#### 实施步骤

1. **设备初始化**：设备首次启动时，向平台上报数据并记录上报时间 `T_current`
2. **计算下次上报时间**：设备每次上报数据后，记录当前时间 `T_current`，并计算下次上报时间 `T_next`：

   ```
   T_next = T_current + 12小时 + 随机偏移量
   ```

   其中，随机偏移量可以是在 -15分钟 到 +15分钟 之间的一个随机值。

3. **调度上报任务**：设备根据计算出的 `T_next` 设置定时任务，确保在该时间点上报数据。

> **注意**：避免固定时间集中上报，造成服务器压力过大。

### 接口信息

| 项目 | 值 |
| --- | --- |
| 接口 URL | `v2/customer/device/report` |
| 请求方式 | POST |
| Content-Type | application/json |

### Header 参数

| 参数名 | 是否必须 | 说明 |
| --- | --- | --- |
| X-AI-IP | 非设备接入时必传 | 设备 IP 地址 |

### Body 参数

| 字段 | 说明 | 值类型 | 是否必填 | 备注 |
| --- | --- | --- | --- | --- |
| deviceId | 设备ID，平台上唯一设备标识 | string | 是 | 获取设备信息接口获取 |
| deviceSecret | 设备密钥，与设备ID一一对应 | string | 是 | 获取设备信息接口获取 |
| productId | 产品ID，平台创建产品时生成 | string | 是 | 平台创建产品时生成 |
| productKey | 产品密钥，平台创建产品时生成 | string | 是 | 平台创建产品时生成 |
| params | 上报携带的参数 | object | 是 | 见下表 |

#### params 参数

| 字段 | 说明 | 值类型 | 是否必填 | 备注 |
| --- | --- | --- | --- | --- |
| innerIp | 内网IP | string[] | 是 | 如无法获取，可以传 `["127.0.0.1"]` |
| netSpeed | 网络分级 | string | 是 | 如无法获取，可以传固定值 `0Mbps` |
| netType | 网络类型 | string | 是 | 如：`wifi`、`5G`、`ethernet` |
| platform | 操作系统 | string | 是 | 如：`Android11`、`RTOS` |
| sdkVersion | SDK版本（固定 `ai_` 前缀） | string | 是 | 使用 API 传 `ai_http_1.0`，若使用 aisdk，aisdk 内部根据实际版本号填充 |
| firmwareVersion | 设备固件版本 | string | 是 | |
| imei | 设备 IMEI | string | 是 | 蜂窝类产品必传，获取不了传空字符串 `""` |
| cmei | 设备 CMEI（15位） | string | 是 | 非蜂窝类产品必传，获取不了传空字符串 `""` |
| mac | MAC地址 | string | 是 | 格式：`xx-xx-xx-xx-xx-xx`，如无法获取传空字符串 `""` |

### 请求示例

```json
{
  "deviceId": "123456789",
  "deviceSecret": "xxxxx",
  "productId": "1234567890123",
  "productKey": "xxxxxxx",
  "params": {
    "innerIp": ["10.229.111.172", "192.168.1.7"],
    "netSpeed": "0Mbps",
    "netType": "WiFi",
    "platform": "rtos",
    "sdkVersion": "ai_http_1.0",
    "firmwareVersion": "0.0.5.2",
    "imei": "",
    "cmei": "",
    "mac": "50-5A-65-51-82-13"
  }
}
```

### 返回值

| 字段 | 说明 | 值类型 |
| --- | --- | --- |
| code | 成功: `200`，其他值为异常 | string |
| message | 响应结果，错误提示通过 msg 分析 | string |
| success | true | bool |
| data | 响应数据 | object |
| data.deviceId | 设备ID，平台上唯一设备标识 | string |
| data.protocolTypeTime | 配置项更新时间 | string |

### 返回示例

```json
{
  "code": "200",
  "message": "成功",
  "success": true,
  "data": {
    "deviceId": "xxx",
    "protocolTypeTime": "xxx"
  }
}
```

## CMEI 编码规则

非蜂窝类产品 CMEI 码为 15 位，规则如下（前 8 位是 TUI 码，厂商在营销系统提交产品报备后系统自动分配）：

| 编码 | 11 | 123456 | 123456 | 1 |
| --- | --- | --- | --- | --- |
| 位数 | 2位 | 6位 | 6位 | 1位 |
| 含义 | 非蜂窝智能硬件标识位，固定为 `11` | 随机码，用来区分产品品牌与型号，由中国移动统一分配 | 序列号，厂家自行填写，标识产品唯一性 | 随机码，此位无实际意义，可以固定为 0-9 的任何一个值，或按照 IMEI 生成规则做校验位 |

## 常见问题 Q&A

### 1. 使用测试环境还是正式环境适配？

**答**：直接使用正式环境适配。

### 2. 获取设备信息接口中的参数 productId 和 productKey 如何获取？

**答**：`productId`（产品ID）和 `productKey`（产品秘钥）在平台创建产品时生成。

### 3. 心跳上报接口何时调用上报？

**答**：心跳上报接口要求设备 24 小时内至少上报一次，可参考文档中提供的策略，或者自行制定上报策略，满足 24 小时内至少上报一次即可。

### 4. 部分设备（如鼠标）在云电脑场景下获取不了设备号导致无法获取设备信息和心跳上报，该如何处理？

**答**：
- **方案一**：如果厂商平台有存储设备号跟账号的对应关系，在云电脑场景下可通过登录的账号找到对应的设备号去获取设备信息和心跳上报
- **方案二**：如果无法通过其他手段获取设备号，则拿产品ID作为设备号去获取设备信息和心跳上报（需要在平台导入此设备号-产品ID）- **不推荐使用此方案**

### 5. 心跳上报接口部分参数无法获取，该如何处理？

**答**：请按照文档的说明，部分参数无法获取时，传默认值。

### 6. 心跳上报接口 CMEI 参数无法获取，该如何处理？

**答**：按照要求，非蜂窝类产品 CMEI 码要在硬件及外包装盒体现，软件同步写入，心跳上报时 CMEI 码必须上传，并在入库测试时检查确认。

### 7. 非蜂窝类产品 CMEI 码如何获取，编码规则是啥？

**答**：详见上文 [CMEI 编码规则](#cmei-编码规则)。

### 8. 设备调用心跳上报接口上报数据如何测试验证？

**答**：查看心跳上报的数据可在沟通群联系终端智能体服务管理平台对接人。
